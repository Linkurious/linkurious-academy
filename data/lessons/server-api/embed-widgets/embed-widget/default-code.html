<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    #container {
      top: 100px;
      left: 100px;
      right: 100px;
      bottom: 0;
      position: absolute;
    }
    iframe {
      border: 1px solid #ccc;
    }
  </style>
  <script src="/node_modules/qwest/qwest.min.js"></script>
</head>
<body>
  <section id="container"></section>

<script>
'use strict';

var BASE_URL = 'http://crunchbase.linkurio.us/';

var queryString  = 'MATCH (n1)-[r]-(n2) RETURN n1,r,n2 LIMIT 5';
var source;
var queryResponse;
var graphData;
var configuration;
var styles;

var qwestOpts = {
  cache: true,
  withCredentials: true,
  dataType: 'json'
};

// Authenticate user
qwest.post(BASE_URL + 'api/auth/login', {
  usernameOrEmail: 'Student 0',
  password: 'student0',
}, qwestOpts)

// Discover datasources
.then(function() {
  return qwest.get(BASE_URL + 'api/dataSources', null, qwestOpts);
})

// Send a Cypher query
.then(function(xhr, response) {
  // Pick first datasource
  source = response.sources[0];

  if (source && source.connected && source.state == 'ready') {
    var url = BASE_URL + 'api/' + source.key + '/graph/rawQuery';
    return qwest.post(url, {
      query: encodeURIComponent(queryString),
      dialect: 'cypher'
    }, qwestOpts);
  }
  throw 'Source unavailable';
})

// Read configuration
.then(function(xhr, response) {
  queryResponse = response;
  var url = BASE_URL + 'api/config?sourceIndex=' + source.configIndex;
  return qwest.get(url, null, qwestOpts);
})

// Create a visualization
.then(function(xhr, response) {
  configuration = response.config;

  var nodes = []; // visualization data
  var edges = []; // visualization data
  var edgeIndex = {}; // used to remove duplicates
  graphData = { nodes: [], edges: [] }; // widget data

  queryResponse.forEach(function(node) {
    if (node.edges && node.edges.length) {
      node.edges.forEach(function(edge) {
        if (!edgeIndex[edge.id]) {
          // Encapsulate the server edge
          edge = {
            id: edge.id,
            source: edge.source,
            target: edge.target,
            data: {
              type: edge.type,
              properties: edge.data
            }
          };

          // Set the edge captions
          edge.label = edge.data.type;

          edges.push({ id: edge.id });
          graphData.edges.push(edge);
        }
        edgeIndex[edge.id] = true;
      });
    }

    // Encapsulate the server node
    node = {
      id: node.id,
      data: {
        categories: node.categories,
        properties: node.data,
        statistics: node.statistics
      }
    };

    // Fake node coordinates, we should apply a layout instead
    node.x = Math.random() * 100;
    node.y = Math.random() * 100;

    // Set the node captions
    node.label = node.data.properties.name; // dataset specific

    // Set the visualization styles
    styles = {
      nodes: {
        size: {
         by: "data.properties.funding_rounds",
         bins: 7,
         min: 5,
         max: 9,
         active: true
        },
        color: {
          by: "data.properties.founded_year",
          bins: 7,
          scheme: "nodes.sequential",
          active: true
        }
      }
    };

    nodes.push({
      id: node.id,
      nodelink: {
        x: node.x,
        y: node.y
      }
    });
    delete node.edges;
    graphData.nodes.push(node);
  });

  var url = BASE_URL + 'api/' + source.key + '/visualizations';
  var options = {
    title: 'My visualization',
    nodes: nodes,
    edges: edges,
    design: { // apply default design config
      palette: configuration.palette,
      styles: styles
    }
  }

  return qwest.post(url, options, qwestOpts);
})

// Create the visualization widget
.then(function(xhr, response) {
  var url = BASE_URL + 'api/widget';
  var options = {
    visualization_id: response.visualization.id,
    content: {
      graph: {
        nodes: graphData.nodes,
        edges: graphData.edges
      },
      palette: configuration.palette,
      styles: styles,
      ui: {
        search: true,
        share: false,
        layout: true,
        fullscreen: true,
        zoom: true,
        legend: true,
        geo: false,
      }
    }
  };

  return qwest.post(url, options, qwestOpts);
})

.then(function(xhr, response) {
  var widgetId = response;
  var url = BASE_URL + 'widget/' + widgetId;

  var code = '<iframe src="' + url + '" width="100%" height="400" frameborder="0" ' +
    'webkitallowfullscreen mozallowfullscreen allowfullscreen>' +
    '</iframe><p><a href="' + url + '" target="_blank">My visualization</a> ' +
    'on <a href="https://linkurio.us" target="_blank">Linkurious</a>.</p>';

  document.getElementById('container').innerHTML = code;
})

.catch(function(e) {
  document.getElementById('container').textContent = e;
  throw e;
});
</script>
</body>
</html>
